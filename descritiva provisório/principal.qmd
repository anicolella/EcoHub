---
title: "Análise descritivas RAMT"
format: html
---

```{r} 
#| echo: false
#| message: false
#| warning: false
#| include: false

library(tidyverse)
library(geobr)
library(ipeadatar)
library(stringr)
library(readr)
library(sf)
library(gtsummary)
library(gt)

df_analise <- st_read(
  dsn   = "C:/Users/jodom/OneDrive/Área de Trabalho/df_classificado.gpkg",
  layer = "df_classificado",
  quiet = TRUE   # ou o nome de camada que você usou no st_write
)

df_eco1 <- df_analise |> select(-c("df", "desc_chave"))

df_areas <- df_analise |>
  mutate(
    # 1. Calcula a área (retorna em m^2 [units])
    area_m2 = st_area(geom),
    
    # 2. Converte para Hectares e remove o tipo 'units' para evitar erros em gráficos
    area_ha_calculada = as.numeric(area_m2) / 10000
  )

 df_joined <- df_analise 
 
```

## 1.Sobre os dados

Os dados dos RAMT (Relatórios de Análise do Mercado de Terras) são elaborados pelo INCRA a partir da análise de diferentes mercados de terras em todo o território nacional, sendo essas terras tratadas como zonas homogêneas. Estas zonas são *clusters* (agrupamentos homogêneos com características semelhantes) que, a partir de então, têm seu valor analisado tendo em vista o uso da terra e as dinâmicas desses diferentes mercados. Os *clusters* são formados com base em um conjunto de variáveis: vocação produtiva da terra, gestão econômica e atividades agrícolas, nível tecnológico e a concentração fundiária (tendo em vista o índice de Gini fundiário). A metodologia de clusterização adotada é a de Ward, criando uma árvore de clusters inicialmente que depois é diferenciada por meio de algoritmos de K-means. O tratamento estatístico pressupõe uma distribuição aproximadamente normal dentro da zona homogênea. Os índices de inflação são corrigidos segundo o IGP-DI. Esse procedimento de clusterização é feito dentro de uma superintendência regional do INCRA.

A metodologia de Ward baseia-se na criação de partições que minimizem a Soma dos Quadrados dos Erros (SQE), ou seja, a soma das distâncias euclidianas quadráticas de cada amostra em relação ao centroide (média) do cluster, conforme a fórmula:

$$
ESS_k = \sum_{i=1}^{n} \| x_i - \bar{x}_k \|^2
$$

A otimização do procedimento de cluster é feito por meio do processo de "K-means". Esse algoritmo forma K grupos diversos de municípios que posteriormente serão modificados movendo cidades de um local ao outro de modo a maximizar ou minimizar a função, aumentando a qualidade do cluster.

O banco de dados estrutura-se em 18 variáveis, organizadas para capturar a dinâmica espacial e econômica do mercado de terras. As observações são indexadas temporalmente (ano) e geograficamente (code_muni, UF, origem), assegurando a identificação unívoca dos registros dos Relatórios de Análise do Mercado de Terras (RAMT).

As variáveis econômicas decompõem-se em tríades métricas (mínimo, médio e máximo) para o Valor da Terra Nua (VTN) e Valor da Terra com Imóvel (VTI). Estatisticamente, estes limites não são arbitrários: segundo a metodologia do INCRA, eles delimitam o intervalo de validade amostral.

Para fins analíticos, a heterogeneidade das classificações originais (tipologia) foi harmonizada na variável categoria_final, garantindo consistência sintática. A dimensão espacial é preservada pela geometria vetorial (geom), habilitando operações de geoprocessamento
```{r}
colnames(df_eco1)
```

O procedimento de unificação de categorias foi feito através do seguinte loop, sendo o loop taxativo, esse loop foi construído com ajuda do gemini, após um processo de verificação das tipologias via a função unique do package "dyplr":

```{r}
#| eval: false
#| code-fold: true
df_classificado <- resultado_igpdi_limpo %>%
  mutate(
    # 1. tratamento dos nomes para garantir o match exato
    desc_chave = stri_trans_general(tipologia_de_uso, "Latin-ASCII"),
    desc_chave = str_to_lower(str_trim(desc_chave)),
    
    # 2. Mapeamento Linear (152 Itens) - Saída padronizada em minúsculo e sem acento
    categoria_final = case_when(
      
      # --- AGRICULTURA ---
      desc_chave == "agricultura graos soja e milho" ~ "agricultura",
      desc_chave == "agricultura" ~ "agricultura",
      desc_chave == "agricola" ~ "agricultura",
      desc_chave == "terra agricola" ~ "agricultura",
      desc_chave == "agricultural" ~ "agricultura",
      desc_chave == "lavoura" ~ "agricultura",
      desc_chave == "hortifrutigranjeiro" ~ "agricultura",
      desc_chave == "cafe (arabica e conilon" ~ "agricultura",
      desc_chave == "cafe conilon" ~ "agricultura",
      desc_chave == "cafe (arabica e conilon)" ~ "agricultura",
      desc_chave == "cafe arabica" ~ "agricultura",
      desc_chave == "agricultura- graos diversos" ~ "agricultura",
      desc_chave == "agricultura-graos diversos" ~ "agricultura",
      desc_chave == "fruticultura laranja" ~ "agricultura",
      desc_chave == "agricola - graos diversos" ~ "agricultura",
      desc_chave == "horticultura/olericultura/granjeiros" ~ "agricultura",
      desc_chave == "culturas anuais" ~ "agricultura",
      desc_chave == "cultura anual" ~ "agricultura",
      desc_chave == "cafe" ~ "agricultura",
      desc_chave == "agricultura anual" ~ "agricultura",
      desc_chave == "cafeicultura" ~ "agricultura",
      desc_chave == "medias propriedades em terras de cultura" ~ "agricultura",
      desc_chave == "terras de cultura com disponibilidade de agua para irrigacao" ~ "agricultura",
      desc_chave == "terras de cafe" ~ "agricultura",
      desc_chave == "agricola-graos soja" ~ "agricultura",
      desc_chave == "terra de agricultura" ~ "agricultura",
      desc_chave == "terra de agricultura com cana-de-aa?aocar em relevo movimentado" ~ "agricultura",
      desc_chave == "1- agricola" ~ "agricultura",
      desc_chave == "agricultura familiar" ~ "agricultura",
      desc_chave == "fruticultura" ~ "agricultura",
      desc_chave == "exploracao granjeira" ~ "agricultura",
      desc_chave == "terra de exploracao agricola" ~ "agricultura",

      # --- PECUÁRIA ---
      desc_chave == "pecuaria" ~ "pecuaria",
      desc_chave == "pecuaria a oeste do mercado" ~ "pecuaria",
      desc_chave == "pecuana" ~ "pecuaria",
      desc_chave == "pecuaria-bovino-pastagem formada" ~ "pecuaria",
      desc_chave == "pecuaria - bovino-pastagem formada" ~ "pecuaria",
      desc_chave == "pecuaria-bovino-pastagem formada." ~ "pecuaria",
      desc_chave == "pecuaria - bovino -pastagem formada" ~ "pecuaria",
      desc_chave == "pecuaria-diversos" ~ "pecuaria",
      desc_chave == "pecuaria-bovino -pastagem formada" ~ "pecuaria",
      desc_chave == "pecuaria - bovino - pastagem formada" ~ "pecuaria",
      desc_chave == "pastagem" ~ "pecuaria",
      desc_chave == "terras para pastejo" ~ "pecuaria",
      desc_chave == "terras com pastagem" ~ "pecuaria",
      desc_chave == "solos com pastagens e potencial para culturas" ~ "pecuaria",
      desc_chave == "pecuaria com potencial agricultura" ~ "pecuaria",
      desc_chave == "terras de pastagem geral" ~ "pecuaria",
      desc_chave == "pecuaria bovino-pastagem formada" ~ "pecuaria",
      desc_chave == "pecuaria." ~ "pecuaria",
      desc_chave == "terra para pecuaria" ~ "pecuaria",
      desc_chave == "pecuaria de alta a baixa representatividade" ~ "pecuaria",
      desc_chave == "terra de pecuaria" ~ "pecuaria",
      desc_chave == "terra de pecua!ria" ~ "pecuaria",
      desc_chave == "3- pecuaria" ~ "pecuaria",
      desc_chave == "2- pecuaria" ~ "pecuaria",
      desc_chave == "pecuaria/pastagem formada" ~ "pecuaria",
      desc_chave == "terra de exploracao pecuaria" ~ "pecuaria",
      desc_chave == "pecuaria (bovinos e pastagem plant)" ~ "pecuaria",

      # --- EXPLORAÇÃO MISTA ---
      desc_chave == "fazenda" ~ "exploracao mista",
      desc_chave == "exploracao misra" ~ "exploracao mista",
      desc_chave == "exploracao mista" ~ "exploracao mista",
      desc_chave == "exploracao mista (fazenda)" ~ "exploracao mista",
      desc_chave == "explotacao mista" ~ "exploracao mista",
      desc_chave == "mista" ~ "exploracao mista",
      desc_chave == "atividade mista" ~ "exploracao mista",
      desc_chave == "exploracao mista - agricola + pastagem" ~ "exploracao mista",
      desc_chave == "exploracao mista agricola + pastagem" ~ "exploracao mista",
      desc_chave == "exploracao mista - agricola + pastagem+ diversificada" ~ "exploracao mista",
      desc_chave == "exploracao mista agricola pastagem" ~ "exploracao mista",
      desc_chave == "exploracao mista agricola + pastagem + floresta plantada" ~ "exploracao mista",
      desc_chave == "exploracao mista agricola + pastagem + diversificada" ~ "exploracao mista",
      desc_chave == "mosaico de pastagens, florestas abertas e vegetacao degradada com babacu/babacual" ~ "exploracao mista",
      desc_chave == "mosaico de vegetacao" ~ "exploracao mista",
      desc_chave == "exploracao mista (pastagens e culturas)" ~ "exploracao mista",
      desc_chave == "uso misto (pecuaria/agricultura)" ~ "exploracao mista",
      desc_chave == "uso misto (pecuaria/agricultura/reflorestamento)" ~ "exploracao mista",
      desc_chave == " agropecuario" ~ "exploracao mista",
      desc_chave == "agropecuaria" ~ "exploracao mista",
      desc_chave == "exploracao mista-agricola + pecuaria" ~ "exploracao mista",
      desc_chave == "exploracao mista (lavoura e pecuaria)" ~ "exploracao mista",
      desc_chave == "terra de exploracao mista" ~ "exploracao mista",
      desc_chave == "terra de exploraa?a?o mista" ~ "exploracao mista",
      desc_chave == "exploracao mista (aquicultura/agricultura irrigada)" ~ "exploracao mista",
      desc_chave == "1- exploracao mista" ~ "exploracao mista",
      desc_chave == "2- exploracao mista" ~ "exploracao mista",
      desc_chave == "exploradio mista" ~ "exploracao mista",
      desc_chave == "exploracao mista (agricultura e/ou pecuaria)" ~ "exploracao mista",
      desc_chave == "agricultura e pecuaria" ~ "exploracao mista",
      desc_chave == "agropecuario" ~ "exploracao mista",

      # --- VEGETAÇÃO NATIVA ---
      desc_chave == "floresta mata nativa" ~ "vegetacao nativa",
      desc_chave == "vegetacao nativa" ~ "vegetacao nativa",
      desc_chave == "vegetacao nativa floresta amazonica" ~ "vegetacao nativa",
      desc_chave == "floresta" ~ "vegetacao nativa",
      desc_chave == "cerrado" ~ "vegetacao nativa",
      desc_chave == "mata" ~ "vegetacao nativa",
      desc_chave == "cerrado-vegetacao nativa" ~ "vegetacao nativa",
      desc_chave == "vegetacao nativa - cerrado" ~ "vegetacao nativa",
      desc_chave == "vegetacao nativa- cerrado" ~ "vegetacao nativa",
      desc_chave == "vegetacao nativa*" ~ "vegetacao nativa",
      desc_chave == "vegetacao nativa *" ~ "vegetacao nativa",
      desc_chave == "terras de cerrado arenosas" ~ "vegetacao nativa",
      desc_chave == "regeneracao/mata" ~ "vegetacao nativa",
      desc_chave == "2- vetetacao nativa" ~ "vegetacao nativa",
      desc_chave == "4- vegetacao nativa" ~ "vegetacao nativa",
      desc_chave == "3- vegetacao nativa" ~ "vegetacao nativa",
      desc_chave == "vetetacao nativa" ~ "vegetacao nativa",
      desc_chave == "lavrado" ~ "vegetacao nativa",
      desc_chave == "floresta natural (mata)" ~ "vegetacao nativa",
      desc_chave == "vegetacao nativa (mata)" ~ "vegetacao nativa",
      desc_chave == "vegetacao nativa - mata atlantica" ~ "vegetacao nativa",
      desc_chave == "vegetacao nativa (mata atlantica)" ~ "vegetacao nativa",
      desc_chave == "terra com mata" ~ "vegetacao nativa",

      # --- SILVICULTURA ---
      desc_chave == "seringal" ~ "silvicultura",
      desc_chave == "silvicultura" ~ "silvicultura",
      desc_chave == "terras para reflorestamento" ~ "silvicultura",
      desc_chave == "floresta plantadasilvicultura" ~ "silvicultura",
      desc_chave == "floresta plantada" ~ "silvicultura",
      desc_chave == "reflorestamento" ~ "silvicultura",
      desc_chave == "vegetacao nativa/silvicultura" ~ "silvicultura",
      desc_chave == "vegetacao nativa/sivicultura" ~ "silvicultura",

      # --- AQUICULTURA ---
      desc_chave == "carcinicultura" ~ "aquicultura",
      desc_chave == "carcinicltura" ~ "aquicultura",
      desc_chave == "nao agricola - carcinicultura" ~ "aquicultura",

      # --- NÃO AGRÍCOLA / URBANO ---
      desc_chave == "nao agricola" ~ "nao agricola",
      desc_chave == "sitios e chacaras" ~ "nao agricola",
      desc_chave == "especulacao imobiliaria" ~ "nao agricola",
      desc_chave == "lazer (sitios/chacaras)" ~ "nao agricola",

      # --- TERRA NUA ---
      desc_chave == "terra nua" ~ "terra nua",

      # --- MEDIA GERAL (Antigo Outros) ---
      desc_chave == "geral" ~ "media geral",
      desc_chave == "uso indefinido (media geral do mrt)" ~ "media geral",
      desc_chave == "media geral (uso indefinido)" ~ "media geral",
      desc_chave == "media geral" ~ "media geral",
      desc_chave == "uso indefinido (media geral)" ~ "media geral",
      desc_chave == "usa indefinido (media geral)" ~ "media geral",
      desc_chave == "uso indefinido" ~ "media geral",
      desc_chave == "todas as tipologias (media geral)" ~ "media geral",
      desc_chave == "uso indefinido media geral" ~ "media geral",
      desc_chave == "uso indefinido (macdia geral do mrt)" ~ "media geral",
      desc_chave == "todas as tipologias" ~ "media geral",
      desc_chave == "amostra geral" ~ "media geral",
      desc_chave == "geral (todas as tipologias)" ~ "media geral",
      desc_chave == "media geral mrt1" ~ "media geral",
      desc_chave == "media geral mrt2" ~ "media geral",
      desc_chave == "media geral mrt3" ~ "media geral",
      desc_chave == "media geral mrt4" ~ "media geral",
      desc_chave == "media geral mrt7" ~ "media geral",
      desc_chave == "media geral mrt8" ~ "media geral",
      desc_chave == "media geral mrt9" ~ "media geral",
      desc_chave == "media geral mrt10" ~ "media geral",
      desc_chave == "uso indef nido (media geral do mrt)" ~ "media geral",
      desc_chave == "uso indef hido (media geral do mrt)" ~ "media geral",
      desc_chave == "todas as tipologias do mrt" ~ "media geral",

      # Safety Net
      TRUE ~ "revisar manualmente"
    )
  )

```
 
Os valores apresentados para terra foram posteriormente deflacionados para o ano de 2024, com uso do indice IGP-DI que é aquele utilizado pelo incra segundo a normativa ( número da normativa, adicionar bibtex) seguindo o seguinte script:

```{r}
#|echo: FALSE
#|eval : FALSE

#### 1. Preparação do Índice (A Lógica do Produto Acumulado) ####
indice_raw <- ipeadata(code = "IGP_IGPDIG", language = "br")

tabela_indices <- indice_raw %>%
  mutate(
    ano = year(as.Date(date)),
    # Transforma taxa percentual em fator multiplicativo (ex: 0.5% vira 1.005)
    fator_mensal = (value / 100) + 1
  ) %>%
  # Agrupa para obter a inflação anualizada
  group_by(ano) %>%
  summarise(
    fator_anual = prod(fator_mensal, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  arrange(ano) %>%
  # --- AQUI ESTÁ A CORREÇÃO QUE VOCÊ PEDIU ---
  # O índice do ano X é o produto de tudo que veio antes (acumulado)
  mutate(indice_acumulado = cumprod(fator_anual))

#### 2. Definindo a Base (Para onde queremos levar o dinheiro) ####
# Vamos pegar o valor do índice no último ano disponível (Ex: 2024)
indice_base_topo <- tail(tabela_indices$indice_acumulado, 1)

#### 3. Cruzamento e Cálculo ####
resultado_igpdi <- df_joined %>%
  mutate(ano = as.numeric(ano)) %>% # Garante numérico para o join
  left_join(tabela_indices, by = "ano") %>%
  mutate(
    # FATOR DE CORREÇÃO:
    # Quanto o dinheiro valia "no final da história" DIVIDIDO por quanto valia "naquele ano"
    fator_deflator = indice_base_topo / indice_acumulado  ,
    
    # Aplica nas colunas
    across(
      c("vti_media", "vti_minimo", "vti_maximo", "vtn_media", "vtn_minimo", "vtn_maximo"), 
      ~ .x * fator_deflator, 
      .names = "IGPDI_{.col}"
    )
  ) %>%
  # Limpeza final (mantém originais e as novas colunas 'real_')
  select(colnames(df_joined), starts_with("IGPDI_{.col}"))

```

## 2.Disponibilidade dos dados
A coleta de dados dos relatórios RAMT apresenta significativa heterogeneidade entre as superintendências regionais do INCRA. A base de dados abrange o período de 2016 a 2025, com destaque para o ano de 2023, que apresenta maior cobertura territorial devido à publicação do Atlas do Mercado de Terras. No entanto, identificaram-se sobreposições entre o Atlas e relatórios de anos adjacentes. Metodologicamente, optou-se pela prevalência dos dados dos relatórios originais em casos de conflito, visando manter a consistência da série histórica. Essa decisão justifica as lacunas observadas em alguns estados nos mapas de 2023, onde as informações do Atlas foram suprimidas em favor dos registros dos relatórios. Além disso, os relatórios nem sempre contemplam todos os municípios da zona homogênea (Mercado de terras), portanto, existem algumas lacunas nos mapas por falta de melhor detalhamento nos municípios. É possível observar que existem alguns relatórios em que somente informações parciais dos mercados de um mesmo stado são publicados.

Seguem os mapas sobre as disponibilidades dos dados dos relatórios:
```{r}
#| echo: false
#| message: false
#| warning: false
#| results: asis 

# ATENÇÃO: A opção 'results: asis' acima é OBRIGATÓRIA.
# Sem ela, o Quarto vai achar que os textos são logs do R e não formatação.

# 1. Preparação (Fora do Loop)
br_outline <- read_country(year = 2020, showProgress = FALSE) 
br_states  <- read_state(code_state = "all", year = 2020, showProgress = FALSE)
anos_disponiveis <- sort(unique(df_analise$ano)) # Garante ordem cronológica

# 2. Abertura do Painel de Abas (Comando Markdown via R)
cat("::: {.panel-tabset}\n\n")

# 3. Loop
for (um_ano in anos_disponiveis) {
  
  # A. Cria o Título da Aba (Markdown)
  # O \n é crucial para o Quarto entender que é um cabeçalho
  cat("## ", um_ano, "\n\n")
  
  # B. Gera o Mapa
  dados_do_ano <- subset(df_analise, ano == um_ano)
  
  p <- ggplot() +
    geom_sf(data = br_outline, fill = "gray95", color = "gray90") +
    geom_sf(data = dados_do_ano, fill = "firebrick", color = NA) + 
    geom_sf(data = br_states, fill = NA, color = "gray40", lwd = 0.3) +
    labs(title = paste("Coleta de dados RAMT:", um_ano), 
         subtitle = paste(n_distinct(dados_do_ano$origem), "municípios com dados"),
         caption = "Fonte: INCRA/RAMT") +
    theme_void() +
    theme(plot.title = element_text(hjust = 0.5, face = "bold", color = "gray20"))
  
  # C. Imprime o Mapa
  print(p)
  
  # D. Fecha o espaço da aba
  cat("\n\n")
}

# 4. Fechamento do Painel
cat(":::\n")
```

As observações variam de acordo com a quantidade de cada tipologia, a quantidade de observações para cada tipologia foi a seguinte:
```{r}
#Rever o parágrafo acima, está ruim.
# Prevenção contra objeto SF pesado
dados_plot <- if(inherits(df_analise, "sf")) sf::st_drop_geometry(df_analise) else df_analise

ggplot(dados_plot, aes(x = fct_rev(fct_infreq(as.factor(categoria_final))), fill = as.factor(categoria_final))) +
  geom_bar(show.legend = FALSE) +
  
  # Gira o gráfico
  coord_flip() + 
  
  labs(
    title = "Contagem por categoria final",
    x = NULL,
    y = "Total de Observações"
  ) +
    theme(
  axis.text.x = element_text(face = "bold", size = 10), # Negrito nas categorias (que estão na esquerda)
  axis.text.y = element_text(face = "bold")             # Se quiser negrito nos números embaixo também
) + 
  theme_minimal()
```

## 3. Análise e distribuições
A estatística descritiva revela uma oscilação expressiva nos valores de VTI e VTN ao longo da série histórica. Essa volatilidade não reflete necessariamente uma tendência de mercado, mas sim a heterogeneidade espacial da coleta de dados em cada exercício. A tabela a seguir consolida as métricas de tendência central (média) e dispersão (mínimos e máximos) para ambas as categorias.

```{r}
# 1. Preparar os dados (Agregação Manual)
tabela_pivo <- df_analise |>
  st_drop_geometry() |>
  group_by(ano) |>
  summarise(
    # Métricas para VTI
    vti_med = mean(vti_media, na.rm = TRUE),
    vti_min = min(vti_minimo, na.rm = TRUE),
    vti_max = max(vti_maximo, na.rm = TRUE),
    
    # Métricas para VTN
    vtn_med = mean(vtn_media, na.rm = TRUE),
    vtn_min = min(vtn_minimo, na.rm = TRUE),
    vtn_max = max(vtn_maximo, na.rm = TRUE),
    
    # Contagem (Opcional, mas bom para auditoria)
    n_registros = n()
  )

# 2. Gerar a Tabela Profissional
tabela_pivo |>
  gt() |>
  
  # --- Cabeçalho ---
  tab_header(
    title = md("**Evolução Histórica de Preços (VTI vs VTN)**"),
    subtitle = "Valores Agregados por Ano (Média Nacional e Amplitude)"
  ) |>
  
  # --- Formatação Numérica (Antes de fundir) ---
  fmt_number(
    columns = -ano, # Formata tudo exceto o ano
    decimals = 0,   # Sem centavos para limpar a vista
    sep_mark = ".",
    dec_mark = ","
  ) |>
  
  # --- O PULO DO GATO: Fusão de Colunas (Pattern) ---
  # Cria o formato: "Média (Mín - Máx)"
  cols_merge(
    columns = c(vti_med, vti_min, vti_max),
    pattern = "{1} ({2} - {3})"
  ) |>
  cols_merge(
    columns = c(vtn_med, vtn_min, vtn_max),
    pattern = "{1} ({2} - {3})"
  ) |>
  
  # --- Renomear as Colunas Finais ---
  cols_label(
    ano = "Ano",
    vti_med = md("**VTI (R$/ha)**<br><small>Média (Mín - Máx)</small>"),
    vtn_med = md("**VTN (R$/ha)**<br><small>Média (Mín - Máx)</small>"),
    n_registros = "Nº Municípios"
  ) |>
  
  # --- Alinhamento e Estilo ---
  cols_align(align = "center", columns = everything()) |>
  opt_row_striping() |> # Listras zebradas para facilitar leitura
  tab_options(
    table.width = pct(100), # Ocupa 100% da largura do container
    data_row.padding = px(6)
  )
```

A distribuição amostral revela a predominância de dados agregados ('Média Geral'), seguida pela Pecuária, refletindo a capilaridade extensiva dessa atividade no território nacional. Nota-se, contudo,  um volume expressivo de dados classificados como 'Exploração Mista', o que sugere desafios na segregação precisa do uso do solo em diversas regionai. 

Os scatter plots mostram a natureza discreta dos dados, os dados são variáveis macroeconomicas agregadas das regiões de homogeniedade determinada pelo incra através do algoritmo de WARD e do procedimento de K-means, nesse sentido, os scatters apenas demosntram um reflexo disso, do contrário seria esperado que os locai com mais áreas apresentassem uma nuvem de pontos que segue as linhas tracejadas. (REVISAR ISSO TÁ ESQUISITO E NA MINHA CABEÇA TA SEGUINDO A LINHA TRACEJADA)
```{r}
# 1. Preparação dos dados (Garantia de Leveza)
dados_scatter <- if(inherits(df_areas, "sf")) sf::st_drop_geometry(df_areas) else df_analise

dados_agrupados <- dados_scatter |>
  group_by(code_muni, categoria_final) |>
  summarise(
    n_obs = n(),
    area_total = first(area_ha_calculada), # Usa a área corrigida do geobr
    .groups = "drop"
  ) |>
  # Filtro de segurança para log
  filter(n_obs > 0, area_total > 0)

# 2. Plot com Correção de Jitter
ggplot(dados_agrupados, aes(x = area_total, y = n_obs)) +
  
  # A CORREÇÃO ESTÁ AQUI:
  # width = 0 (Não mexe na Área, que é precisa)
  # height = 0.2 (Espalha o N verticalmente para desfazer a linha reta)
  geom_jitter(aes(color = categoria_final), alpha = 0.4, width = 0, height = 0.2) +
  
  # Escalas Logarítmicas
  scale_x_log10(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
  # Breaks manuais para facilitar leitura no log
  scale_y_log10(breaks = c(1, 2, 5, 10, 20, 50, 100)) +
  
  # Linha de Tendência (Regressão Linear no Log)
  geom_smooth(method = "lm", color = "black", linetype = "dashed", se = FALSE, size = 0.5) +
  
  facet_wrap(~categoria_final, scales = "free") +
  
  labs(
    title = "Densidade Amostral: Área vs. Observações (Ajustado)",
    subtitle = "Dispersão com Jitter para visualizar concentração em N=1",
    x = "Área da Zona (ha) [Log]",
    y = "Nº de Observações [Log]"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

Segue uma tabela do valor de terra por quantil ao longo de toda a amostragem, lembrando que os valores aqui apresentados são fruto de correções inflacionárias de todos os valores para o ano de 2024. 

```{r}
#| message: false
#| warning: false

# 1. Cálculo dos Quantis por Categoria
tabela_quantis <- df_analise |>
  st_drop_geometry() |>
  filter(!is.na(vti_media), vti_media > 0) |>
  group_by(categoria_final) |>
  summarise(
    N = n(),
    # Calcula os cortes de preço que dividem o mercado
    P10 = quantile(vti_media, 0.10),
    P25 = quantile(vti_media, 0.25),
    Mediana = median(vti_media),
    P75 = quantile(vti_media, 0.75),
    P90 = quantile(vti_media, 0.90)
  ) |>
  arrange(desc(Mediana)) # Ordena do mais caro para o mais barato

# 2. Renderização da Tabela
tabela_quantis |>
  gt() |>
  tab_header(
    title = md("**Estrutura de Preços: Distribuição por Quantis**"),
    subtitle = "Valores de Terra (VTI) em R$/ha"
  ) |>
  fmt_number(
    columns = c(P10, P25, Mediana, P75, P90),
    decimals = 0,
    sep_mark = ".",
    dec_mark = ","
  ) |>
  cols_label(
    categoria_final = "Categoria",
    N = "Amostras",
    P10 = "Piso (10%)",
    P25 = "Baixo (25%)",
    Mediana = "Médio (50%)",
    P75 = "Alto (75%)",
    P90 = "Teto (90%)"
  ) |>
  # Destaque visual para a Mediana (o valor mais provável)
  tab_style(
    style = list(
      cell_text(weight = "bold", color = "black"),
      cell_fill(color = "lightgray")
    ),
    locations = cells_body(columns = Mediana)
  ) |>
  data_color(
    columns = c(Mediana),
    method = "numeric",
    palette = "Greens" # Escala de cor para mostrar quem vale mais
  )
```
Panorama geográfico 
Os dados não tão bonitos, a organizaçãi tá esquistassa, eu tenho q revisar eles

```{r}
# 1. Preparação: O "Snapshot" do Mercado (Excluindo 2025)
dados_panorama <- df_analise |>
  # LIMPEZA CRÍTICA:
  # 1. Remove 2025 (Sem IGP-DI)
  # 2. Remove sujeira (Zeros e NAs)
  filter(ano < 2025, !is.na(vti_media), vti_media > 0) |>
  
  # Filtra categorias principais
  filter(categoria_final %in% c("agricultura", "pecuaria", "media geral", "exploracao mista")) |>
  
  group_by(code_muni, categoria_final) |>
  # Pega o ano mais recente DISPONÍVEL (que agora será no máximo 2024)
  slice_max(order_by = ano, n = 1) |> 
  ungroup() 

# 2. Criação dos Quantis (Classes de Preço)
# Recalculando os pentis com a base limpa
dados_panorama <- dados_panorama |>
  group_by(categoria_final) |> 
  mutate(
    # cut_number garante o mesmo número de observações em cada cor
    classe_preco = cut_number(vti_media, n = 5, labels = c("Muito Baixo", "Baixo", "Médio", "Alto", "Muito Alto"))
  ) |>
  ungroup()

# 3. O Mapa (Choropleth)
ggplot(dados_panorama) +
  geom_sf(aes(fill = classe_preco), color = NA, lwd = 0) + 
  
  # Escala de Cores: Magma invertido (Amarelo/Branco = Muito Alto)
 scale_fill_brewer(
  palette = "Spectral",
  direction = -1, # Inverte para Vermelho ser o 'Alto' e Azul o 'Baixo'
  name = "Faixa de Valor (VTI)"
  ) +
  
  facet_wrap(~categoria_final, ncol = 2) +
  
  labs(
    title = "Panorama de Valor da Terra (Até 2024)",
    subtitle = "Classificação por Quantis baseada no último dado corrigido (IGP-DI).",
    caption = "Nota: Dados de 2025 excluídos por ausência de deflator consolidado."
  ) +
  
  theme_void() + 
  theme(
    legend.position = "right",
    strip.text = element_text(face = "bold", size = 11),
    plot.title = element_text(face = "bold")
  )
```

Histogramas de distribuição por categoria (Texto do gemini revisar)

A análise de densidade (Kernel Density Estimation) refuta a hipótese de normalidade na distribuição de preços, revelando um comportamento multimodal marcante, especialmente nas categorias 'Pecuária' e 'Exploração Mista'.

Estatisticamente, a existência de múltiplos picos (modas) sugere a coexistência de submercados distintos sob a mesma rotulagem administrativa. No caso da Pecuária, a trimodalidade observada indica uma segmentação tecnológica e geográfica severa: terras de fronteira (baixa liquidez), pecuária extensiva consolidada e áreas de potencial conversão agrícola (precificadas pelo custo de oportunidade da soja).

Essa heterogeneidade implica que a utilização de médias simples (VTI Médio) como medida de tendência central carrega alto risco de viés, uma vez que o valor médio frequentemente recai nos 'vales' de densidade — zonas de preço onde poucas transações reais ocorrem.

```{r}
# 1. Preparação (Mesma de antes)
dados_hist <- if(inherits(df_analise, "sf")) sf::st_drop_geometry(df_analise) else df_analise

dados_hist <- dados_hist |>
  filter(vti_media > 0) |>
  filter(categoria_final %in% c("agricultura", "pecuaria", "media geral", "exploracao mista", "silvicultura", "vegetacao nativa"))

# 2. O Plot Híbrido (Barras + Linha Suave)
ggplot(dados_hist, aes(x = vti_media)) +
  
  # Histograma normalizado (Eixo Y = Densidade)
  geom_histogram(
    aes(y = after_stat(density), fill = categoria_final), 
    color = "white", 
    alpha = 0.5, # Transparência para ver a sobreposição
    bins = 40, 
    show.legend = FALSE
  ) +
  
  # A Linha de Densidade (Kernel Density Estimation)
  geom_density(
    color = "black", 
    size = 0.8, 
    adjust = 1.5 # Suavização (1 = Padrão, >1 = Mais liso)
  ) +
  
  # Escala Logarítmica
  scale_x_log10(
    labels = scales::label_number(prefix = "R$ ", scale_cut = scales::cut_short_scale()),
    breaks = c(1000, 5000, 10000, 50000, 100000, 500000)
  ) +
  
  facet_wrap(~categoria_final, scales = "free_y") +
  
  labs(
    title = "Distribuição de Preços (Histograma + Densidade)",
    subtitle = "A curva preta suaviza a tendência. Formato de 'Sino' confirma Log-Normalidade.",
    x = "Valor da Terra (R$/ha) [Log]",
    y = "Densidade de Probabilidade"
  ) +
  
  theme_minimal() +
  theme(
    strip.text = element_text(face = "bold", size = 11),
    axis.text.x = element_text(angle = 30, hjust = 1)
  )

```

O VTN não é apenas "diferente", ele é mais sensível à localização. Enquanto o VTI reflete o Investimento Total, o VTN reflete a Renda Ricardiana (a vantagem produtiva inerente daquele pedaço de chão).

```{r}
# 1. Preparação (Mesma de antes)
dados_hist <- if(inherits(df_analise, "sf")) sf::st_drop_geometry(df_analise) else df_analise

dados_hist <- dados_hist |>
  filter(vti_media > 0) |>
  filter(categoria_final %in% c("agricultura", "pecuaria", "media geral", "exploracao mista", "silvicultura", "vegetacao nativa"))

# 2. O Plot Híbrido (Barras + Linha Suave)
ggplot(dados_hist, aes(x = vtn_media)) +
  
  # Histograma normalizado (Eixo Y = Densidade)
  geom_histogram(
    aes(y = after_stat(density), fill = categoria_final), 
    color = "white", 
    alpha = 0.5, # Transparência para ver a sobreposição
    bins = 40, 
    show.legend = FALSE
  ) +
  
  # A Linha de Densidade (Kernel Density Estimation)
  geom_density(
    color = "black", 
    size = 0.8, 
    adjust = 1.5 # Suavização (1 = Padrão, >1 = Mais liso)
  ) +
  
  # Escala Logarítmica
  scale_x_log10(
    labels = scales::label_number(prefix = "R$ ", scale_cut = scales::cut_short_scale()),
    breaks = c(1000, 5000, 10000, 50000, 100000, 500000)
  ) +
  
  facet_wrap(~categoria_final, scales = "free_y") +
  
  labs(
    title = "Distribuição de Preços (Histograma + Densidade)",
    subtitle = "A curva preta suaviza a tendência. Formato de 'Sino' confirma Log-Normalidade.",
    x = "Valor da Terra (R$/ha) [Log]",
    y = "Densidade de Probabilidade"
  ) +
  
  theme_minimal() +
  theme(
    strip.text = element_text(face = "bold", size = 11),
    axis.text.x = element_text(angle = 30, hjust = 1)
  )
```

Box plot - VTN e VTI

```{r}
# 1. Preparação: Pivotagem (Wide -> Long)
dados_box <- if(inherits(df_analise, "sf")) sf::st_drop_geometry(df_analise) else df_analise

dados_comparativos <- dados_box |>
  # Filtra sujeira e categorias principais
  filter(vti_media > 0, vtn_media > 0) |>
  filter(categoria_final %in% c("agricultura", "pecuaria", "media geral", "exploracao mista", "silvicultura", "vegetacao nativa")) |>
  
  # Seleciona apenas o necessário para pivotar
  select(categoria_final, vti_media, vtn_media) |>
  
  # Transforma colunas em linhas (VTI e VTN viram "Tipo de Valor")
  pivot_longer(
    cols = c(vti_media, vtn_media),
    names_to = "tipo_valor",
    values_to = "valor_ha"
  ) |>
  
  # Renomeia para ficar bonito na legenda
  mutate(
    tipo_valor = factor(tipo_valor, 
                        levels = c("vti_media", "vtn_media"), 
                        labels = c("VTI (Com Imóvel)", "VTN (Terra Nua)"))
  )

# 2. O Plot (Boxplot Pareado)
ggplot(dados_comparativos, aes(x = reorder(categoria_final, valor_ha, FUN = median), y = valor_ha, fill = tipo_valor)) +
  
  # Boxplot: Mostra Mediana, Quartis e Outliers
  geom_boxplot(outlier.alpha = 0.2, outlier.size = 0.5, outlier.color = "gray40") +
  
  # Escala Logarítmica (Crucial)
  scale_y_log10(
    labels = scales::label_number(prefix = "R$ ", scale_cut = scales::cut_short_scale()),
    breaks = c(1000, 5000, 10000, 50000, 100000, 500000)
  ) +
  
  # Cores contrastantes (Laranja pro Capital, Azul pra Terra Nua - ou vice-versa)
  scale_fill_manual(values = c("VTI (Com Imóvel)" = "#E69F00", "VTN (Terra Nua)" = "#56B4E9")) +
  
  coord_flip() + # Deita o gráfico para facilitar leitura dos nomes
  
  labs(
    title = "Dispersão de Preços: VTI vs. VTN",
    subtitle = "A distância entre as caixas representa o valor agregado das benfeitorias.",
    x = NULL, # Remove label redundante
    y = "Valor por Hectare (Log)",
    fill = "Métrica"
  ) +
  
  theme_minimal() +
  theme(
    legend.position = "top",
    axis.text.y = element_text(face = "bold", size = 10),
    panel.grid.major.y = element_blank() # Limpa linhas horizontais para focar nas caixas
  )
```


```{r}
# 1. Preparação
dados_uf <- if(inherits(df_analise, "sf")) sf::st_drop_geometry(df_analise) else df_analise

dados_uf <- dados_uf |>
  filter(vti_media > 0) |>
  filter(categoria_final %in% c("agricultura", "pecuaria", "silvicultura", "vegetacao nativa")) |>
  # Garante que temos a UF (Se não tiver a coluna abbrev_state, extraímos do código)
  mutate(
    UF = if("UF" %in% names(dados_uf)) UF else substr(code_muni, 1, 2)
  )

# 2. O Plot (Boxplot Ordenado)
ggplot(dados_uf, aes(x = reorder(UF, vti_media, FUN = median), y = vti_media)) +
  
  # Boxplot limpo
  geom_boxplot(aes(fill = categoria_final), outlier.size = 0.5, outlier.alpha = 0.3, show.legend = FALSE) +
  
  # Escala Logarítmica (Obrigatória para comparar PI com SP)
  scale_y_log10(
    labels = scales::label_number(prefix = "R$ ", scale_cut = scales::cut_short_scale()),
    breaks = c(1000, 10000, 50000, 100000, 500000)
  ) +
  
  # Facetas Livres (Cada categoria tem seu próprio ranking de estados)
  facet_wrap(~categoria_final, scales = "free", ncol = 2) +
  
  coord_flip() + # Estados no eixo Y para leitura fácil
  
  labs(
    title = "Hierarquia de Valor: Ranking Estadual por Uso",
    subtitle = "Ordenado pela Mediana de Preço (VTI). Escala Logarítmica.",
    x = NULL,
    y = "Valor da Terra (R$/ha) [Log]"
  ) +
  
  theme_minimal() +
  theme(
    strip.text = element_text(face = "bold", size = 11),
    axis.text.y = element_text(size = 7) # Fonte menor para caber todas as UFs
  )
```


Médias ponderadas por área, por estado:
```{r}
#| echo: false
#| message: false
#| warning: false
#| results: asis 

library(ggplot2)
library(dplyr)
library(sf)

# 1. CÁLCULO DAS MÉTRICAS (VTI - Com Imóvel)
serie_vti_ponderada <- df_areas |>
  st_drop_geometry() |>
  # Garante UF e Peso de segurança
  mutate(
    UF = if("abbrev_state" %in% names(df_areas)) abbrev_state else substr(code_muni, 1, 2),
    area_peso = ifelse(is.na(area_ha_calculada) | area_ha_calculada <= 0, 1, area_ha_calculada)
  ) |>
  # Filtra VTI válido e categorias principais
  filter(ano < 2025, vti_media > 0) |>
  filter(categoria_final %in% c("agricultura", "pecuaria", "media geral")) |> 
  
  # AQUI ESTAVA FALTANDO: O AGRUPAMENTO E RESUMO
  group_by(ano, UF, categoria_final) |> 
  summarise(
    # Mediana (Tendência Central)
    vti_mediano = median(vti_media, na.rm = TRUE),
    
    # Média Ponderada (Valor do Estoque)
    vti_ponderado = sum(vti_media * area_peso, na.rm = TRUE) / sum(area_peso, na.rm = TRUE),
    
    n_obs = n(),
    .groups = "drop"
  ) |>
  # Só mantém anos/estados com dados suficientes para não gerar ruído
  filter(n_obs >= 5)

# 2. TRATAMENTO DE SIGLAS (De Código IBGE para Letras)
serie_vti_tratada <- serie_vti_ponderada |>
  mutate(
    UF_cod = as.character(UF),
    UF_sigla = case_match(UF_cod,
      "11" ~ "RO", "12" ~ "AC", "13" ~ "AM", "14" ~ "RR", "15" ~ "PA", "16" ~ "AP", "17" ~ "TO",
      "21" ~ "MA", "22" ~ "PI", "23" ~ "CE", "24" ~ "RN", "25" ~ "PB", "26" ~ "PE", "27" ~ "AL", "28" ~ "SE", "29" ~ "BA",
      "31" ~ "MG", "32" ~ "ES", "33" ~ "RJ", "35" ~ "SP",
      "41" ~ "PR", "42" ~ "SC", "43" ~ "RS",
      "50" ~ "MS", "51" ~ "MT", "52" ~ "GO", "53" ~ "DF",
      .default = UF_cod # Se já estiver certo, mantém
    )
  )

lista_ufs_vti <- sort(unique(serie_vti_tratada$UF_sigla))

# 3. LOOP DE PLOTAGEM (ABAS POR ESTADO)
cat("::: {.panel-tabset}\n\n")

for (uf_atual in lista_ufs_vti) {
  
  cat("## ", uf_atual, "\n\n")
  
  dados_plot_uf <- serie_vti_tratada |> 
    filter(UF_sigla == uf_atual)
  
  p <- ggplot(dados_plot_uf, aes(x = ano)) +
    
    # Linha Tracejada = Mediana (Referência)
    geom_line(aes(y = vti_mediano, color = "Mediana (Simples)"), linetype = "dashed", size = 0.8) +
    
    # Linha Sólida = Média Ponderada (Valor do Estoque)
    geom_line(aes(y = vti_ponderado, color = "Média Ponderada (Área)"), size = 1.2) +
    
    facet_wrap(~categoria_final, scales = "free_y") +
    
    scale_y_continuous(labels = scales::label_number(prefix = "R$ ", scale_cut = scales::cut_short_scale())) +
    scale_x_continuous(breaks = seq(2016, 2024, 2)) +
    
    # Cores (Azul para VTI)
    scale_color_manual(values = c("Mediana (Simples)" = "gray50", "Média Ponderada (Área)" = "darkblue")) +
    
    labs(
      title = paste("Evolução do VTI (Com Imóvel) -", uf_atual),
      subtitle = "Comparativo: Ponderado pela Área vs. Mediana Central",
      y = "VTI Médio (R$/ha)",
      x = NULL,
      color = NULL
    ) +
    
    theme_minimal() +
    theme(
      legend.position = "top",
      plot.title = element_text(face = "bold"),
      strip.text = element_text(face = "bold", size = 12)
    )
  
  print(p)
  cat("\n\n")
}

cat(":::\n")
```

Evolução de preços do VTN
```{r}
#| echo: false
#| message: false
#| warning: false
#| results: asis 

library(ggplot2)
library(dplyr)
library(sf) # Caso precise manipular geom, mas st_drop garante leveza

# 1. CÁLCULO DAS MÉTRICAS (VTN)
serie_vtn_ponderada <- df_areas |>
  st_drop_geometry() |>
  # Garante UF e Peso
  mutate(
    UF = if("abbrev_state" %in% names(df_areas)) abbrev_state else substr(code_muni, 1, 2),
    area_peso = ifelse(is.na(area_ha_calculada) | area_ha_calculada <= 0, 1, area_ha_calculada)
  ) |>
  # FILTRO CRÍTICO: Agora olhamos para VTN > 0
  filter(ano < 2025, vtn_media > 0) |>
  filter(categoria_final %in% c("agricultura", "pecuaria", "media geral")) |> 
  
  group_by(ano, UF, categoria_final) |> 
  summarise(
    # --- MEDIANA DO VTN ---
    vtn_mediano = median(vtn_media, na.rm = TRUE),
    
    # --- MÉDIA PONDERADA DO VTN ---
    vtn_ponderado = sum(vtn_media * area_peso, na.rm = TRUE) / sum(area_peso, na.rm = TRUE),
    
    n_obs = n(),
    .groups = "drop"
  ) |>
  filter(n_obs >= 5)

# 2. TRATAMENTO DE SIGLAS (De-Para IBGE)
serie_vtn_tratada <- serie_vtn_ponderada |>
  mutate(
    UF_cod = as.character(UF),
    UF_sigla = case_match(UF_cod,
      "11" ~ "RO", "12" ~ "AC", "13" ~ "AM", "14" ~ "RR", "15" ~ "PA", "16" ~ "AP", "17" ~ "TO",
      "21" ~ "MA", "22" ~ "PI", "23" ~ "CE", "24" ~ "RN", "25" ~ "PB", "26" ~ "PE", "27" ~ "AL", "28" ~ "SE", "29" ~ "BA",
      "31" ~ "MG", "32" ~ "ES", "33" ~ "RJ", "35" ~ "SP",
      "41" ~ "PR", "42" ~ "SC", "43" ~ "RS",
      "50" ~ "MS", "51" ~ "MT", "52" ~ "GO", "53" ~ "DF",
      .default = UF_cod
    )
  )

lista_ufs_vtn <- sort(unique(serie_vtn_tratada$UF_sigla))

# 3. LOOP DE PLOTAGEM (ABAS)
cat("::: {.panel-tabset}\n\n")

for (uf_atual in lista_ufs_vtn) {
  
  cat("## ", uf_atual, "\n\n")
  
  dados_plot_uf <- serie_vtn_tratada |> 
    filter(UF_sigla == uf_atual)
  
  p <- ggplot(dados_plot_uf, aes(x = ano)) +
    
    # Linha Tracejada = Mediana VTN
    geom_line(aes(y = vtn_mediano, color = "Mediana (Simples)"), linetype = "dashed", size = 0.8) +
    
    # Linha Sólida = Ponderada VTN
    geom_line(aes(y = vtn_ponderado, color = "Média Ponderada (Área)"), size = 1.2) +
    
    facet_wrap(~categoria_final, scales = "free_y") +
    
    scale_y_continuous(labels = scales::label_number(prefix = "R$ ", scale_cut = scales::cut_short_scale())) +
    scale_x_continuous(breaks = seq(2016, 2024, 2)) +
    
    # Cores Diferentes para VTN (Verde/Cinza para diferenciar do VTI azul)
    scale_color_manual(values = c("Mediana (Simples)" = "gray50", "Média Ponderada (Área)" = "darkgreen")) +
    
    labs(
      title = paste("Evolução do Valor da Terra Nua (VTN) -", uf_atual),
      subtitle = "Comparativo: Ponderado pela Área vs. Mediana Central",
      y = "VTN (R$/ha)",
      x = NULL,
      color = NULL
    ) +
    
    theme_minimal() +
    theme(
      legend.position = "top",
      plot.title = element_text(face = "bold"),
      strip.text = element_text(face = "bold", size = 12)
    )
  
  print(p)
  cat("\n\n")
}

cat(":::\n")
```



```{r}
library(ggplot2)
library(dplyr)
library(sf)

# 1. FILTRO DE ESTABILIDADE (Define quem é "Município Guerreiro")
# Objetivo: Evitar viés de composição. Só queremos analisar a tendência de preço
# de locais que reportaram dados consistentemente ao longo do tempo.

# Remove geometria para ficar leve
dados_painel <- if(inherits(df_analise, "sf")) sf::st_drop_geometry(df_analise) else df_analise

municipios_estaveis <- dados_painel |>
  filter(ano < 2025, vti_media > 0) |>
  group_by(code_muni, categoria_final) |>
  summarise(
    anos_presentes = n_distinct(ano),
    .groups = "drop"
  ) |>
  # CRITÉRIO DE CORTE: Só aceita quem tem pelo menos 4 anos de dados
  filter(anos_presentes >= 4)

# 2. FILTRAGEM DOS DADOS ORIGINAIS
# Mantém apenas as linhas correspondentes aos municípios estáveis
dados_serie_limpa <- dados_painel |>
  semi_join(municipios_estaveis, by = c("code_muni", "categoria_final")) |>
  filter(ano < 2025)

# 3. O GRÁFICO "SPAGHETTI" (Trajetória Individual + Tendência)
ggplot(dados_serie_limpa, aes(x = ano, y = vti_media)) +
  
  # A. O "Espaguete" (Caos Individual)
  # Cada linha cinza é um município. Alpha baixo (0.15) para ver onde acumula.
  geom_line(aes(group = code_muni), alpha = 0.15, color = "gray50", size = 0.3) +
  
  # B. A Tendência Central ROBUSTA (Suavização LOESS)
  # A linha colorida resume o comportamento do grupo estável
  geom_smooth(aes(color = categoria_final), method = "loess", se = TRUE, size = 1.2) +
  
  # Separa por uso para não misturar escalas
  facet_wrap(~categoria_final, scales = "free_y") +
  
  # Escalas e Formatação
  scale_y_log10(labels = scales::label_number(prefix = "R$ ", scale_cut = scales::cut_short_scale())) +
  scale_x_continuous(breaks = seq(2016, 2024, 2)) + # Garante anos pares no eixo
  
  labs(
    title = "Trajetória de Preços: Análise de Painel Estável (N >= 4 anos)",
    subtitle = "Linhas cinzas = Municípios individuais. Linha colorida = Tendência suavizada.",
    caption = "Apenas municípios com recorrência temporal foram mantidos para evitar viés de composição.",
    y = "VTI (R$/ha) [Log]",
    x = "Ano"
  ) +
  
  theme_minimal() +
  theme(
    legend.position = "none", # A cor já está explicada no facet
    strip.text = element_text(face = "bold", size = 11)
  )
```